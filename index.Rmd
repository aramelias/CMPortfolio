---
title: "Computational Musicology Portfolio"
author: "Aram Elias"
output:
  flexdashboard::flex_dashboard:
    storyboard: true
---

```{r include=FALSE}
knitr::opts_chunk$set(include = FALSE)
knitr::opts_chunk$set(error = FALSE)
library(tidyverse)
library(spotifyr)
library(compmus)
library(ggplot2)
library(plotly)
library(gridExtra)
```

```{r}
# Creating a custom theme
theme_ayreon = function(){
  theme_linedraw() %+replace%
    theme(
      panel.grid = element_line(color = "gray")
    )
}
```

### The structure of Ayreon's songs has changed over time, becoming both simpler and more varied.

```{r}
osiris <- 
  get_tidy_audio_analysis("39VbILtU4hPAb7zDxdiU4z") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"
      )
  )
```

```{r}
osiris_pitches <-
  ggplot(compmus_self_similarity(osiris, pitches, "cosine"),
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_ayreon() +
  labs(title = "Isis And Osiris", subtitle="Chroma similarity", x = "", y = "")

osiris_pitches
```
```{r}
osiris_timbre <-
  ggplot(compmus_self_similarity(osiris, timbre, "cosine"),
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_ayreon() +
  labs(title = "Isis And Osiris", subtitle="Timbre similarity", x = "", y = "")

osiris_timbre
```

```{r}
breakdown <- 
  get_tidy_audio_analysis("2bDcXeWeQGULkJEuDpB7wv") %>%
  compmus_align(bars, segments) %>%
  select(bars) %>%
  unnest(bars) %>%
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  ) %>%
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"
      )
  )
```

```{r}
breakdown_pitches <-
  ggplot(compmus_self_similarity(breakdown, pitches, "cosine"),
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_ayreon() +
  labs(title = "The Day That The World Breaks Down", subtitle="Chroma similarity", x = "", y = "")

breakdown_pitches
```

```{r}
breakdown_timbre <-
  ggplot(compmus_self_similarity(breakdown, timbre, "cosine"),
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_ayreon() +
  labs(title = "The Day That The World Breaks Down", subtitle="Timbre similarity", x = "", y = "")

breakdown_timbre
```

```{r include=TRUE, echo=FALSE}
grid.arrange(osiris_pitches, osiris_timbre, breakdown_pitches, breakdown_timbre)
```

***

While many of Ayreon's songs have distinct parts, most of these are repeated throughout the course of one song in some way, shape or form. This can most clearly be seen in the eleven-minute track *Isis And Osiris*, from their second album, *Into The Electric Castle*. This song was chosen based on the fact that many listeners agree it to be most representative of their work, and because its structure is immediately noticeable to the human ear. To the left are two self-similarity matrices (SSMs) for this track, which compare each bar to all other bars in the song; one in terms of chroma (melody) features, the other in term of timbre (instrument) features. 

The song's clear structure is in no small part due to the fact that some parts (such as the "chorus" parts of the different segments) are repeated almost identically, which shows as solid blue blocks in the SSM. This is clearly visible in the block-like structure, which also reveal that the first and last segments of the song are quite similar -- this is intentional, as at its *highest* level, the track follows an **ABCA** structure. Each **A**, **B** and **C** part can then be divided into subparts that repeat within the confines of that part. The timbre-based SSM shows that despite variations in melody, the song's timbre is highly consistent.

Comparing this to *The Day that the World Breaks Down*, the first track of their newest album, *The Source*, it becomes clear that something has changed. There is a higher variation in both chroma and timbre, but the chroma structure also appears more regular, with a checkerboard-like pattern emerging in both SSMs for this song.


### Introduction and Corpus

<!-- ![Logo](https://iconape.com/wp-content/files/gt/296369/svg/ayreon-logo-logo-icon-png-svg.png){width=50%} -->

Dutch progressive-metal band, *Ayreon*, has released six concept albums between 1995 and 2017. It may be worthwhile to compare these albums to one another to see how the band has developed over time, as while Ayreon's content is often described as having a unique, characteristic sound, it has not stayed the same. A human listener will be able to notice differences right away, with newer albums being described as "richer" or more complex.

Some songs in different albums reference one another, and for these it could also be interesting to see how much they have in common musically speaking. Some other songs are considered outliers due to not sounding the same as the rest of the album, or even having more in common with other albums to the human ear.

With most songs being over five minutes in length and having distinct musical segments with complex rhythms, and each album consisting of about fifteen songs, a large amount of data on this band is available on Spotify. As stated before, tracks on more recent albums are generally seen as more complex, and it may be of interest to see if this complexity affects other features of their songs that can be traced back to a trend across albums.

A limitation of this corpus would be a lack of other material to compare it with; however, with the band citing older bands such as Pink Floyd as inspiration, looking into similarities there might also be a good avenue for research.

```{r}
# Retrieve data
ayreon <- get_playlist_audio_features("", "3O1z9gRNz9DiB9wujbgLiV")

# Remove stray song
ayreon <- subset(ayreon, track.album.name != "Timeline")

# Remove unnecessary columns (mostly empty or irrelevant to the music itself)
ayreon <- subset(ayreon, select = -c(playlist_id, playlist_name, playlist_img, playlist_owner_name, playlist_owner_id,
                  added_at, primary_color, added_by.href, added_by.id, added_by.type, added_by.uri, added_by.external_urls.spotify,
                  track.artists, track.available_markets, track.disc_number, track.episode, track.explicit,
                  is_local, track.is_local, track.preview_url, track.track, track.type, video_thumbnail.url, mode,
                  track.album.album_type, track.album.artists, track.album.available_markets, track.album.href,
                  track.album.id, track.album.images, track.album.release_date_precision, track.album.type))

# Clean up some album names
ayreon$track.album.name[ayreon$track.album.name == "The Final Experiment (Special Edition)"] <- "The Final Experiment"
ayreon$track.album.name[ayreon$track.album.name == "Universal Migrator Pt.1 & 2"] <- "Universal Migrator"
ayreon$mode_name <- ifelse(ayreon$mode_name == "minor", "Minor", "Major")

# Put the albums in chronological order using a factor
ayreon$album_factor = factor(ayreon$track.album.name, levels = c("The Final Experiment", "Into The Electric Castle",
                                                                 "Universal Migrator", "The Human Equation",
                                                                 "01011001", "The Source"))
```

### Over time, Ayreon's albums have become more consistent in terms of valence and energy.

```{r include=TRUE, echo=FALSE}
ggplotly(ggplot(ayreon, aes(x = energy, y = valence, size = loudness, fill = mode_name, name = track.name)) +
  geom_point(shape = 21, color = "#000000", alpha = 0.5) +
  scale_x_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1), minor_breaks = NULL) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1), minor_breaks = NULL) +
  scale_size_continuous(trans = "exp", guide = "none") +
  facet_wrap(~album_factor) +
  labs(title = "Energy and valence of Ayreon albums", caption = "Data source: Spotify",
       x = "Energy", y = "Valence", size = "Loudness", fill = "Mode") +
  theme_ayreon(),
  tooltip = c("name", "energy", "valence", "loudness", "mode_name")
)
```

***

This plot is an overview of Ayreon's six albums, in chronological order. The valence and energy are plotted against each other on the axes, with each circle representing a track from the album in the title. The size of a circle represents the track's loudness and the color represents the mode.

It clearly shows that, especially through time, the band has gravitated towards higher-energy tracks with low to medium valence, and tracks have also become louder on average. Major-mode tracks also tend to have a higher energy and valence, but this is more clearly visible in later albums than in earlier ones. Most importantly, however, tracks have become more clustered in the lower-right region instead of being more spread-out.